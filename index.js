"use strict";!function(){var i=Math.random()*Math.random()*10;console.log("The current generation has a seed of "+i+".");var s={};s.floor=0,s.wall=100,s.roomCell=10,s.roomEdge=200,s.roomCorner=1e4,s.marked=5,s.digged=50;new function(){var e,t,C=this;Array.prototype.outOfBounds=function(e,t){return e<0||t<0||e>=this[0].length||t>=this.length},Array.prototype.copy=function(){for(var e=[],t=0;t<this.length;t++)e.push(this[t]);return e},Array.prototype.getIndex=function(e){for(var t in this)if(this.hasOwnProperty(t)&&this[t]===e)return t;return-1},Array.prototype.contains=function(e){return-1!==this.getIndex(e)},Array.prototype.remove=function(e){var t=this.getIndex(e);return 1!==t&&(this.splice(t,1),!0)},this.RNG=function(e){this.fixedSeed=e,this.seed=e,this.generate=function(){var e=1e4*Math.sin(this.seed++);return e-Math.floor(e)},this.generateInt=function(e,t){return void 0===e?0===this.generateInt(1):(void 0===t&&(t=e,e=0),Math.floor(this.generate()*(t-e))+e)}},this.rng=new this.RNG(i),this.map=[],this.mapSize=25,this.roomsMin=6,this.roomsMax=7,this.roomRadiusMin=1,this.roomRadiusMax=3,this.largeRoomRadiusMin=4,this.largeRoomRadiusMax=6,this.largeRoomDecrement=1,this.tileScale=4,this.playerVision=7,this.elements=[],this.pythagorean=function(e,t,i){return void 0===i||i?Math.sqrt(e*e+t*t):e*e+t*t},this.createElement=function(e,t,i){i=i||{};var s=document.createElement(e);for(var n in i)s[n]=i[n];return t.appendChild(s),s},this.removeElementTransition=function(e,t,i){void 0===i&&(i=[]),e.classList.add("no-transition"),t.apply(C,i),e.offsetHeight,e.classList.remove("no-transition")},window.onresize=this.resizeViewport=function(e){var t,i;for(C.viewportWidth=Math.max(document.documentElement.clientWidth,window.innerWidth||0),C.viewportHeight=Math.max(document.documentElement.clientHeight,window.innerHeight||0),C.windowSize=Math.min(C.viewportWidth,C.viewportHeight),C.tileWidth=.6*C.windowSize/C.tileScale,C.tileHeight=.8*C.windowSize/C.tileScale,C.log.div.style.width=C.windowSize+"px",C.log.div.style.height=C.windowSize/5.25+"px",t=0;t<C.log.elements.length;t++)(i=C.log.elements[t]).style.fontSize=C.windowSize/40+"px",i.style.top=t*C.windowSize/40+C.windowSize/256+"px";if(C.container.style.width=C.container.style.height=C.windowSize+"px",C.plane.style.width=C.tileWidth*C.mapSize+"px",C.plane.style.height=C.tileHeight*C.mapSize+"px",!0!==e){for(C.updateList(C.tiles),t=0;t<C.elements.length;t++)C.removeElementTransition(C.elements[t].element,C.updateItem,[C.elements[t]]);C.removeElementTransition(C.planeContainer,C.updateCamera)}},this.container=this.createElement("div",document.body,{id:"container",className:"absolute-center"}),this.plane=this.createElement("div",this.container,{id:"plane"}),this.Log=function(){this.entries=[],this.elements=[],this.div=C.createElement("div",C.container,{className:"log"}),this.div.style.width=C.windowSize+"px",this.div.style.height=C.windowSize/6+"px",this.ul=C.createElement("ul",this.div),this.print=function(e){var t,i,s,n;if(this.entries[0]!==e)for(this.entries.unshift(e),(s=C.createElement("li",this.ul)).style.top="0",s.style.fontSize=C.windowSize/40+"px",s.index=0,s.repeats=1,s.extra="",s.drawing=!0,n=setInterval(function(){s.innerHTML+=e[s.index],++s.index>=e.length&&(s.drawing=!1,clearInterval(n))},20),this.elements.unshift(s),i=0;i<this.elements.length;i++)(t=this.elements[i]).style.top=i*C.windowSize/40+C.windowSize/256+"px",7<=i&&(t.style.opacity=0);else(s=this.elements[0]).drawing||(s.index=0,s.repeats++,2===s.repeats?(s.extra=" (x"+s.repeats+")",n=setInterval(function(){s.innerHTML+=s.extra[s.index],++s.index>=s.extra.length&&clearInterval(n)},20)):(s.innerHTML=s.innerHTML.slice(0,s.innerHTML.length-s.extra.length),s.extra=" (x"+s.repeats+")",100<s.repeats&&(s.extra=" (x100+)"),s.innerHTML+=s.extra))}},this.log=new this.Log,this.log.print("Change the screen size to reduce lag."),this.log.print("Descend staircases with '.'."),this.log.print("You can interact with doors using 'C' and 'O'."),this.log.print("Move with the arrow keys or ykuhlbjn."),this.resizeViewport(!0),this.toRGB=function(e){for(var t,i={},s=["red","green","blue"],n=0,r=0;r<e.length;r+=2)t=e[r]+e[r+1],i[s[n]]=parseInt("0x"+t),n++;return i},this.Pathfinder=function(){var w=[],b=[],k=[];for(var e in this.costs={},s)this.costs[e]=s[e];this.manhattan=function(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)},this.calculate=function(e,t,i,s,n){var r,o,a,h,l,p,m,c,d,g,u,y,f,x,v;for(void 0===s&&(s=!0),void 0===n&&(n=!1),r=0;r<i.length;r++)for(b[r]=[],o=0;o<i[r].length;o++)a=i[r][o],n?(y=this.costs.wall,a.marked&&(y=this.costs.marked),a.roomCell&&(y=this.costs.roomCell),a.roomEdge&&(y=this.costs.roomEdge),a.roomCorner&&(y=this.costs.roomCorner),a.digged&&(y=this.costs.digged),f=0<r&&0<o&&r<i.length-1&&o<i[r].length-1):(f=!0,"#"===a.char&&(f=!1),y=C.tileTypes[a.char].cost),(c={open:!1,closed:!1}).x=o,c.y=r,c.g=1/0,c.h=this.manhattan({x:r,y:o},t),c.f=c.g+c.h,c.parent=null,c.cost=y,c.walkable=f,b[r][o]=c;for(k=[],(c=b[e.y][e.x]).g=0,w=[c];0<w.length&&(c=w.sort(function(e,t){return e.f-t.f})[0],b[(v=c).y][v.x].open=!1,b[v.y][v.x].closed=!0,w.remove(v),c.x!==t.x||c.y!==t.y);)for(l=c.y-1;l<=c.y+1;l++)for(h=c.x-1;h<=c.x+1;h++)g={x:h,y:l},1!==(m=this.manhattan(c,g))&&!s||!c.walkable||i.outOfBounds(h,l)||b[l][h].closed||(d=b[c.y][c.x],u=b[l][h],p=d.g+m+u.cost,(!u.open||p<=u.g)&&(b[l][h].g=p,b[l][h].f=p+this.manhattan(g,t),b[l][h].parent=c,x=u,w.contains(x)||(w.push(x),b[x.y][x.x].open=!0)));if(b[t.y][t.x].closed){for(c=b[t.y][t.x];c.x!==e.x||c.y!==e.y;)c=c.parent,k.push({x:c.x,y:c.y});return k.reverse()}return[]}},this.pathfinder=new this.Pathfinder,this.Rectangle=function(e,t,i,s){this.left=e,this.top=t,this.right=i,this.bottom=s,this.intersect=function(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top},this.intersectPoint=function(e,t){return void 0===t&&(t=e.y,e=e.x),e>this.left&&e<this.right&&t>this.top&&t<this.bottom},this.contains=function(e){var t={x:e.left,y:e.top},i={x:e.right,y:e.bottom};return this.intersectPoint(t)&&this.intersectPoint(i)}},this.Room=function(){var t,i,s,n,r,o,a,h,l,p,m,c,d,g,u,y=!1,f=0;this.children=[],this.make=function(){for(;!d;){if(0===C.rng.generateInt(4)?this.type="large":this.type="normal","large"===this.type?(a=C.rng.generateInt(C.largeRoomRadiusMin,C.largeRoomRadiusMax+1),h=C.rng.generateInt(C.largeRoomRadiusMin,C.largeRoomRadiusMax+1)):"normal"===this.type&&(a=C.rng.generateInt(C.roomRadiusMin,C.roomRadiusMax+1),h=C.rng.generateInt(C.roomRadiusMin,C.roomRadiusMax+1)),l=2*a+1,p=2*h+1,i=2*C.rng.generateInt((C.mapSize-l-2)/2)+1,s=2*C.rng.generateInt((C.mapSize-p-2)/2)+1,m=new C.Rectangle(i,s,i+l-1,s+p-1),this.rectangle=m,d=function(){for(e=0;e<C.rooms.length;e++)if(c=C.rooms[e],n=c.rectangle,g=new C.Rectangle(i-1,s-1,i+l+1,s+p+1).intersect(new C.Rectangle(n.left-1,n.top-1,n.right+1,n.bottom+1)),y||(y="large"!==this.type&&n.contains(m)),y){for(t=0;t<c.children.length;t++)if(r=c.children[t].rectangle,new C.Rectangle(i-1,s-1,i+l+1,s+p+1).intersect(new C.Rectangle(r.left-1,r.top-1,r.right+1,r.bottom+1)))return!1;c.children.push(this)}else if(g)return!1;return!0}.apply(this),this.widthRadius=a,this.heightRadius=h,this.inside=y,256<=f){u=!0;break}f++}if(u)return!1;for(this.rectangle=m,this.center={x:i+a,y:s+h},this.edges=[],this.trueEdges=[],this.border=[],e=m.top;e<=m.bottom;e++)e>m.top&&e<m.bottom&&this.edges.push({x:m.left-1,y:e},{x:m.right+1,y:e}),this.trueEdges.push({x:m.left-1,y:e},{x:m.right+1,y:e});for(e=m.left;e<=m.right;e++)e>m.left&&e<m.right&&this.edges.push({x:e,y:m.top-1},{x:e,y:m.bottom+1}),this.trueEdges.push({x:e,y:m.top-1},{x:e,y:m.bottom+1});for(this.border.push({x:m.left-1,y:m.top-1},{x:m.right+1,y:m.top-1},{x:m.left-1,y:m.bottom+1},{x:m.right+1,y:m.bottom+1}),e=0;e<this.border.length;e++)o=this.border[e],C.map[o.y][o.x].roomCorner=!0;for(e=0;e<this.trueEdges.length;e++)this.border.push(this.trueEdges[e]);if(y)for(e=0;e<this.border.length;e++)o=this.border[e],C.map[o.y][o.x].color="#ff0000",C.map[o.y][o.x].insideEdge=!0;for(var e=0;e<this.trueEdges.length;e++)o=this.trueEdges[e],C.map[o.y][o.x].roomEdge=!0;return C.rooms.push(this),!0},this.mark=function(){var e,t;if(!this.inside)for(e=this.rectangle.top;e<=this.rectangle.bottom;e++)for(t=this.rectangle.left;t<=this.rectangle.right;t++)C.marked.contains({x:t,y:e})||C.marked.push({x:t,y:e}),C.map[e][t].marked=!0,C.map[e][t].roomCell=!0;C.rooms.push(this)}},this.Tile=function(e,t,i){this.x=e,this.y=t,this.char=i,this.color=C.tileTypes[this.char].color,this.solid=C.tileTypes[this.char].solid,this.opaque=C.tileTypes[this.char].opaque,this.visible=!1,this.visited=!1,this.roomCell=!1,this.roomEdge=!1,this.roomCorner=!1,this.insideEdge=!1,this.insidePath=!1,this.marked=!1,this.digged=!1,this.tile=C.createElement("div",C.tileContainer,{className:C.tileTypes[this.char].className}),this.text=C.createElement("div",this.tile,{className:"inner-text",innerHTML:i}),this.change=function(e){this.char=e,this.color=C.tileTypes[this.char].color,this.solid=C.tileTypes[this.char].solid,this.opaque=C.tileTypes[this.char].opaque,this.text.innerHTML=this.char},this.reset=function(){this.visible=!1,this.visited=!1,this.marked=!1,this.digged=!1,this.roomEdge=!1,this.roomCorner=!1,this.roomCell=!1,this.insideEdge=!1,this.insidePath=!1}},this.Element=function(e,t,i,s,n){n=n||"",this.x=e,this.y=t,this.char=i,this.color=s,this.classes=n,this.type="element",this.element=C.createElement("div",C.elementContainer,{className:n+" element"}),this.text=C.createElement("div",this.element,{className:"inner-text",innerHTML:this.char}),C.elements.push(this)},this.Player=function(e,t){var a=this.root=new C.Element(e,t,"@","#ffffff","player");a.vision=C.playerVision,a.visible=!0,a.visibleTiles=[],a.move=function(e,t){var i=a.x+e,s=a.y+t;C.map.outOfBounds(i,s)||C.tileTypes[C.map[s][i].char].solid?"+"===C.map[s][i].char&&(C.log.print("You open the door."),C.map[s][i].change("/"),a.raycast()):(a.x=i,a.y=s,">"===C.map[a.y][a.x].char&&C.log.print("There's a staircase going down here."),a.raycast()),C.updateList(C.elements),C.updateCamera()},a.raycast=function(){var e,t,i,s,n,r,o;for(e=0;e<a.visibleTiles.length;e++)a.visibleTiles[e].visible=!1,C.updateItem(a.visibleTiles[e]);for(a.visibleTiles=[],a.visibleTiles.length=0,a.illuminate(a.x,a.y),t=0;t<360;t+=3)for(i=t*Math.PI/180,r=Math.cos(i),o=Math.sin(i),e=1;e<a.vision&&(s=Math.round(a.x+r*e),n=Math.round(a.y+o*e),!C.map.outOfBounds(s,n)&&!C.tileTypes[a.illuminate(s,n).char].opaque);e++);},a.illuminate=function(e,t){var i=C.map[t][e];return i.visible=!0,i.visited=!0,a.visibleTiles.push(i),C.updateItem(i),i},a.openDoors=function(){var e,t,i=0;for(e=a.y-1;e<=a.y+1;e++)for(t=a.x-1;t<=a.x+1;t++)t===a.x&&e===a.y||"+"!==C.map[e][t].char||(C.map[e][t].change("/"),i++);return 0<i?(1===i?C.log.print("You cautiously open a door."):C.log.print("You cautiously open some doors."),a.raycast()):C.log.print("There's no doors to open!"),0<i},a.closeDoors=function(){var e,t,i=0;for(e=a.y-1;e<=a.y+1;e++)for(t=a.x-1;t<=a.x+1;t++)t===a.x&&e===a.y||"/"!==C.map[e][t].char||(C.map[e][t].change("+"),i++);return 0<i?(1===i?C.log.print("You cautiously close a door."):C.log.print("You cautiously close some doors."),a.raycast()):C.log.print("There's no doors to close!"),0<i},a.descend=function(){">"===C.map[a.y][a.x].char?(C.log.print("You descend the staircase. It crumbles under your weight!"),C.generate()):C.log.print("You can't go down here!")}},this.tileTypes={"#":{className:"tile wall",color:"#2F4F4F",solid:!0,opaque:!0,cost:1e7},"+":{className:"tile",color:"#A52A2A",solid:!0,opaque:!0,cost:5},"/":{className:"tile",color:"#A52A2A",solid:!1,opaque:!1,cost:0},"&middot;":{className:"tile floor",color:"#808000",solid:!1,opaque:!1,cost:0},"@":{className:"tile player",color:"#ffffff",solid:!1,opaque:!1},">":{className:"tile",color:"#ffffff",solid:!1,opaque:!1,cost:0}},this.tiles=[],this.updateItem=function(e){var t=e.tile||e.element;if(t.style.left=C.tileWidth*e.x+"px",t.style.top=C.tileHeight*e.y+"px",t.style.fontSize=C.windowSize/C.tileScale+"px",t.style.zIndex=C.map.length*C.map[e.y].length-(e.y*C.map.length+e.x),"element"===e.type&&(t.style.zIndex*=100),void 0!==C.player&&"element"!==e.type&&C.player.x===e.x&&C.player.y===e.y?t.style.opacity="0":t.style.opacity="1",e.visible){var i=C.pythagorean(e.x-C.player.x,e.y-C.player.y),s=e.color.slice(1,e.color.length),n=C.toRGB(s),r="#",o=["red","green","blue"],a=1-i/C.player.vision;1<a&&(a=1),a<0&&(a=0);for(var h=0;h<o.length;h++)n[o[h]]*=a,n[o[h]]=Math.round(n[o[h]]).toString(16),n[o[h]].length<2&&(n[o[h]]="0"+n[o[h]]),r+=n[o[h]];t.style.color=r}else e.visited?t.style.color="#060606":t.style.color="#000"},this.updateList=function(e){for(var t=0;t<e.length;t++)C.updateItem(e[t])},this.updateCamera=function(){var e=(-C.player.x-.5)*C.tileWidth+C.windowSize/2+"px",t=(-C.player.y-.5)*C.tileHeight-C.windowSize/2+"px";C.planeContainer.style.left=e,C.planeContainer.style.top=t},this.planeContainer=this.createElement("div",this.plane,{className:"plane-container",id:"plane-container"}),this.tileContainer=this.createElement("div",this.planeContainer,{className:"plane-container",id:"tile-container"}),this.elementContainer=this.createElement("div",this.planeContainer,{className:"plane-container",id:"element-container"}),this.tileContainer.style.zIndex="0",this.elementContainer.style.zIndex="1",this.makeTiles=function(){for(e=0;e<this.mapSize;e++)for(this.map[e]=[],t=0;t<this.mapSize;t++)this.map[e][t]=new this.Tile(t,e,"#"),this.tiles.push(this.map[e][t])},this.rooms=[],this.marked=[],this.generate=function(){var e,t,i,s,n,r,o,a,h,l,p,m,c,d,g,u,y,f,x,v,w,b,k,I,E,M,T=this.rng.generateInt(this.roomsMin,this.roomsMax+1),z=0;for(e=0;e<this.mapSize;e++)for(t=0;t<this.mapSize;t++)this.map[e][t].change("#"),this.map[e][t].reset();for(this.rooms=[],this.marked=[],g=[p={x:2*this.rng.generateInt((this.mapSize-1)/2)+1,y:2*this.rng.generateInt((this.mapSize-1)/2)+1}];0<g.length;){for(u=!1,f=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}];!u&&0<f.length;)y=f[x=this.rng.generateInt(f.length)],f.splice(x,1),d={x:m=2*y.x+p.x,y:c=2*y.y+p.y},u=!(this.map.outOfBounds(m,c)||this.map[c][m].marked&&0!==this.rng.generateInt(128));if(u){for(h=this.map[c][m].marked,e=0;e<=2;e++)m=e*y.x+p.x,c=e*y.y+p.y,this.map.outOfBounds(m,c)||(this.map[c][m].marked=!0);p=h?g.pop():(g.push(d),d)}else p=g.pop()}for(u=!1;!u;)for(e=0;e<T;e++){if(!(v=new this.Room).make())return this.generate();v.mark(),"large"===v.type&&(e+=C.largeRoomDecrement),e===T-1&&(u=!0)}for(b=[],k=[],e=(w=this.rooms.copy()).length;e--;)b.push(!1);for(;k.length<w.length||z<8;){if(e=t=void 0,k.length<w.length){for(;void 0===e||b[e];)e=this.rng.generateInt(w.length);for(s=w[e];void 0===t||[this.rooms[t]].contains(s);)t=this.rng.generateInt(this.rooms.length);n=this.rooms[t],b[e]=!0,k.push(s)}else{for(;e===t;)e=this.rng.generateInt(this.rooms.length),t=this.rng.generateInt(this.rooms.length);z++}if(0<(I=this.pathfinder.calculate(s.center,n.center,this.map,!1,!0)).length)for(R=0;R<I.length;R++)i=I[R],this.rooms[this.rooms.getIndex(s)].inside&&(this.map[i.y][i.x].insidePath=!0),this.marked.contains(i)||this.marked.push(i),this.map[i.y][i.x].digged=!0}for(e=0;e<this.marked.length;e++)p=this.marked[e],this.map[p.y][p.x].insideEdge&&!this.map[p.y][p.x].insidePath||this.map[p.y][p.x].change("&middot;");for(v=this.rooms[this.rng.generateInt(this.rooms.length)],M=[],e=0;e<this.rooms.length;e++)M[e]={steps:this.pathfinder.calculate(this.rooms[e].center,v.center,this.map).length,obj:this.rooms[e].center};for(M.sort(function(e,t){return t.steps-e.steps}),E=M[0].obj,this.map[E.y][E.x].change(">"),o=v.center.x+this.rng.generateInt(-v.widthRadius,v.widthRadius+1),a=v.center.y+this.rng.generateInt(-v.heightRadius,v.heightRadius+1),this.player?(this.player.x=o,this.player.y=a):this.player=new this.Player(o,a).root,e=0;e<this.rooms.length;e++)for(v=this.rooms[e],t=0;t<v.trueEdges.length;t++)if(r=v.trueEdges[t],"&middot;"===this.map[r.y][r.x].char){l=!0;for(var R=r.y-1;R<=r.y+1;R++){for(var S=r.x-1;S<=r.x+1;S++)if(1===this.pathfinder.manhattan({x:S,y:R},r)&&"+"===this.map[R][S].char){l=!1;break}if(!l)break}l&&this.map[r.y][r.x].change("+")}for(C.removeElementTransition(C.player.element,C.updateItem,[C.player]),this.player.raycast(),e=0;e<this.map.length;e++)for(t=0;t<this.map[e].length;t++)C.removeElementTransition(C.map[e][t].tile,C.updateItem,[C.map[e][t]]);return C.removeElementTransition(C.planeContainer,C.updateCamera),!0},this.makeTiles(),this.generate(),this.updateList(this.tiles),this.updateItem(this.player),this.updateCamera(),this.keyDown=function(e){switch(e.keyCode){case 37:C.player.move(-1,0);break;case 39:C.player.move(1,0);break;case 38:C.player.move(0,-1);break;case 40:C.player.move(0,1);break;case 89:C.player.move(-1,-1);break;case 75:C.player.move(0,-1);break;case 85:C.player.move(1,-1);break;case 72:C.player.move(-1,0);break;case 76:C.player.move(1,0);break;case 66:C.player.move(-1,1);break;case 74:C.player.move(0,1);break;case 78:C.player.move(1,1);break;case 79:C.player.openDoors();break;case 67:C.player.closeDoors();break;case 190:C.player.descend()}},this.keyUp=function(e){},document.onkeydown=this.keyDown,document.onkeyup=this.keyUp}}();